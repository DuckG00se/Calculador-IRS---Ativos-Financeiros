
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora IRS Portugal (Cat. E & G)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-blue': '#003366',
              'brand-green': '#006633',
              'brand-red': '#990000',
              'light-bg': '#f8f9fa',
              'dark-text': '#212529'
            },
          },
        },
      }
    </script>
  </head>
  <body class="bg-light-bg text-dark-text">
    <div id="app-container">
        <!-- App content will be rendered here by JavaScript -->
    </div>

    <script>
        // --- DATA & CONSTANTS ---
        const TAX_BRACKETS_2025 = [ { upTo: 16058, rate: 0.17, base: 0 }, { upTo: 21578, rate: 0.22, base: 2729.86 }, { upTo: 27146, rate: 0.25, base: 3944.26 }, { upTo: 38632, rate: 0.32, base: 5621.56 }, { upTo: 50483, rate: 0.35, base: 9343.43 }, { upTo: 83696, rate: 0.45, base: 14418.83 }, { upTo: Infinity, rate: 0.48, base: 29364.68 } ];
        const SOLIDARITY_SURCHARGE = { level1_threshold: 80000, level1_rate: 0.025, level2_threshold: 250000, level2_rate: 0.05 };
        const HOLDING_PERIOD_DISCOUNTS = [ { years: 2, discount: 0.10 }, { years: 5, discount: 0.20 }, { years: 8, discount: 0.30 } ];
        const FLAT_RATE = 0.28;
        const EU_DIVIDEND_EXCLUSION = 0.50;
        const MANDATORY_AGGREGATION_THRESHOLD = 83696;
        const MS_IN_DAY = 1000 * 60 * 60 * 24;

        // --- APPLICATION STATE ---
        let state = {
            activeTab: 'CAT_G',
            transactions: [],
            dividends: [],
            annualIncome: 50000,
            simulationResult: null,
            annexData: null,
        };

        // --- TAX CALCULATION LOGIC ---
        const calculateHoldingPeriodDiscount = (days) => { if (days <= 730) return 0; const years = days / 365.25; if (years <= 5) return HOLDING_PERIOD_DISCOUNTS[0].discount; if (years <= 8) return HOLDING_PERIOD_DISCOUNTS[1].discount; return HOLDING_PERIOD_DISCOUNTS[2].discount; };
        const calculateProgressiveTax = (taxableIncome) => { if (taxableIncome <= 0) return { progressiveTax: 0, solidaritySurcharge: 0 }; let tax = 0; const bracket = TAX_BRACKETS_2025.find(b => taxableIncome <= b.upTo); if (bracket) { const baseBracket = TAX_BRACKETS_2025[TAX_BRACKETS_2025.indexOf(bracket) - 1]; const incomeInBracket = taxableIncome - (baseBracket ? baseBracket.upTo : 0); tax = (baseBracket ? baseBracket.base : 0) + incomeInBracket * bracket.rate; } else { const lastBracket = TAX_BRACKETS_2025[TAX_BRACKETS_2025.length - 2]; tax = lastBracket.base + (taxableIncome - lastBracket.upTo) * TAX_BRACKETS_2025[TAX_BRACKETS_2025.length - 1].rate; } let surcharge = 0; if (taxableIncome > SOLIDARITY_SURCHARGE.level1_threshold) { const surchargeableIncome = taxableIncome - SOLIDARITY_SURCHARGE.level1_threshold; if (taxableIncome > SOLIDARITY_SURCHARGE.level2_threshold) { const incomeInLevel1 = SOLIDARITY_SURCHARGE.level2_threshold - SOLIDARITY_SURCHARGE.level1_threshold; const incomeInLevel2 = taxableIncome - SOLIDARITY_SURCHARGE.level2_threshold; surcharge = (incomeInLevel1 * SOLIDARITY_SURCHARGE.level1_rate) + (incomeInLevel2 * SOLIDARITY_SURCHARGE.level2_rate); } else { surcharge = surchargeableIncome * SOLIDARITY_SURCHARGE.level1_rate; } } return { progressiveTax: tax, solidaritySurcharge: surcharge }; };
        const calculateCapitalGains = (transactions) => { const buys = transactions.filter(t => t.type === 'BUY').sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()); const sells = transactions.filter(t => t.type === 'SELL').sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()); const buyQueue = buys.map(t => ({ transaction: t, remainingQty: t.quantity })); const gainEntries = []; for (const sell of sells) { let sellQtyToMatch = sell.quantity; const sellValuePerUnit = (sell.price * sell.quantity - sell.costs) / sell.quantity; for (const buy of buyQueue) { if (sellQtyToMatch === 0) break; if (buy.remainingQty === 0 || buy.transaction.asset !== sell.asset) continue; const matchQty = Math.min(sellQtyToMatch, buy.remainingQty); const buyValuePerUnit = (buy.transaction.price * buy.transaction.quantity + buy.transaction.costs) / buy.transaction.quantity; const gain = (sellValuePerUnit - buyValuePerUnit) * matchQty; const sellDate = new Date(sell.date); const buyDate = new Date(buy.transaction.date); const holdingPeriodDays = Math.round((sellDate.getTime() - buyDate.getTime()) / MS_IN_DAY); const holdingDiscount = calculateHoldingPeriodDiscount(holdingPeriodDays); const taxableGain = gain > 0 ? gain * (1 - holdingDiscount) : gain; gainEntries.push({ asset: sell.asset, buyDate: buy.transaction.date, sellDate: sell.date, holdingPeriodDays, quantity: matchQty, buyValue: buyValuePerUnit * matchQty, sellValue: sellValuePerUnit * matchQty, gain, holdingDiscount, taxableGain, isShortTerm: holdingPeriodDays < 365, }); buy.remainingQty -= matchQty; sellQtyToMatch -= matchQty; } } const positiveGains = gainEntries.filter(g => g.gain > 0); const totalGains = positiveGains.reduce((acc, g) => acc + g.gain, 0); const totalTaxableGains = positiveGains.reduce((acc, g) => acc + g.taxableGain, 0); const hasShortTermGains = gainEntries.some(g => g.isShortTerm && g.gain > 0); const totalLosses = gainEntries.filter(g => g.gain < 0).reduce((acc, g) => acc + g.gain, 0); return { totalGains: totalGains + totalLosses, totalTaxableGains: totalTaxableGains + totalLosses, hasShortTermGains, gainEntries }; };
        const calculateDividendTax = (dividends) => { const totalGross = dividends.reduce((acc, d) => acc + d.grossAmount, 0); const totalWithholding = dividends.reduce((acc, d) => acc + d.withholdingTax, 0); const taxableAmountFlat = totalGross; const taxableAmountAggregated = dividends.reduce((acc, d) => { if (d.source === 'PT_EU_EEE') { return acc + (d.grossAmount * (1 - EU_DIVIDEND_EXCLUSION)); } return acc + d.grossAmount; }, 0); return { totalGross, totalWithholding, taxableAmountFlat, taxableAmountAggregated }; };
        const generateAnnexes = (gainsResult, dividendResult) => { const annexG = gainsResult.gainEntries.map(g => ({ year: new Date(g.sellDate).getFullYear().toString(), assetType: 'Ações/Obrigações', valueRealization: g.sellValue, valueAcquisition: g.buyValue, expenses: 0, })); const annexJ = []; const annexE = []; if (dividendResult.totalGross > 0) { const ptEuDividends = dividendResult.totalGross; if (ptEuDividends > 0) { annexE.push({ incomeType: 'E20', grossIncome: ptEuDividends }); } } return { g: annexG, j: annexJ, e: annexE }; };
        const calculateTaxSimulation = (transactions, dividends, annualIncome) => { const gainsResult = calculateCapitalGains(transactions); const dividendResult = calculateDividendTax(dividends); const taxableGains = Math.max(0, gainsResult.totalTaxableGains); const catGTaxFlat = taxableGains * FLAT_RATE; const catETaxFlat = dividendResult.taxableAmountFlat * FLAT_RATE; const foreignTaxCreditFlat = Math.min(catETaxFlat, dividendResult.totalWithholding); const finalTaxFlat = catGTaxFlat + catETaxFlat - foreignTaxCreditFlat; const totalTaxableIncomeForAggregation = annualIncome + taxableGains + dividendResult.taxableAmountAggregated; const { progressiveTax, solidaritySurcharge } = calculateProgressiveTax(totalTaxableIncomeForAggregation); const totalTaxAggregated = progressiveTax + surcharge; const taxOnAggregatedDividends = calculateProgressiveTax(annualIncome + dividendResult.taxableAmountAggregated).progressiveTax - calculateProgressiveTax(annualIncome).progressiveTax; const foreignTaxCreditAggregated = Math.min(taxOnAggregatedDividends, dividendResult.totalWithholding); const finalTaxAggregated = totalTaxAggregated - foreignTaxCreditAggregated; const mandatoryAggregation = gainsResult.hasShortTermGains && (annualIncome + gainsResult.totalGains) > MANDATORY_AGGREGATION_THRESHOLD; const finalChoice = mandatoryAggregation ? 'AGGREGATED' : (finalTaxFlat < finalTaxAggregated ? 'FLAT' : 'AGGREGATED'); const result = { flatRate: { totalTax: catGTaxFlat + catETaxFlat, catGTax: catGTaxFlat, catETax: catETaxFlat, finalTax: finalTaxFlat }, aggregatedRate: { totalTaxableIncome: totalTaxableIncomeForAggregation, progressiveTax, solidaritySurcharge, totalTax: totalTaxAggregated, foreignTaxCreditUsed: foreignTaxCreditAggregated, finalTax: finalTaxAggregated, }, mandatoryAggregation, finalChoice, gainsResult, dividendResult, }; const annexes = generateAnnexes(gainsResult, dividendResult); return { result, annexes }; };
        
        // --- HTML TEMPLATES & RENDER FUNCTIONS ---
        const formatCurrency = (value, currency = 'EUR') => value.toLocaleString('pt-PT', { style: 'currency', currency });

        const renderTransactionLedger = () => {
            const tableBody = state.transactions.map(tx => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium ${tx.type === 'BUY' ? 'text-green-600' : 'text-red-600'}">${tx.type === 'BUY' ? 'Compra' : 'Venda'}</td>
                    <td class="px-6 py-4">${tx.asset}</td>
                    <td class="px-6 py-4">${tx.date}</td>
                    <td class="px-6 py-4">${tx.quantity.toLocaleString()}</td>
                    <td class="px-6 py-4">${formatCurrency(tx.price, tx.currency)}</td>
                    <td class="px-6 py-4">${formatCurrency(tx.costs, tx.currency)}</td>
                    <td class="px-6 py-4"><button data-id="${tx.id}" class="remove-tx-btn text-red-600 hover:text-red-800 font-bold text-lg">&times;</button></td>
                </tr>
            `).join('');
            
            return `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4 text-brand-blue">Registo de Transações (Mais-Valias)</h3>
                    <form id="tx-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4 p-4 border rounded-lg">
                        <select name="type" class="p-2 border rounded-md"><option value="BUY">Compra</option><option value="SELL">Venda</option></select>
                        <input type="text" name="asset" placeholder="Ativo (e.g., AAPL)" required class="p-2 border rounded-md" />
                        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="p-2 border rounded-md" />
                        <input type="number" name="quantity" placeholder="Quantidade" required min="0.000001" step="any" class="p-2 border rounded-md" />
                        <input type="number" name="price" placeholder="Preço Total" required min="0.01" step="any" class="p-2 border rounded-md" />
                        <input type="number" name="costs" placeholder="Custos" value="0" min="0" step="any" class="p-2 border rounded-md" />
                        <div class="flex gap-2">
                            <select name="currency" class="p-2 border rounded-md w-1/3">
                                <option value="EUR">EUR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="CHF">CHF</option>
                            </select>
                            <input type="number" name="exchangeRate" placeholder="Taxa Câmbio p/ EUR" min="0" step="any" class="p-2 border rounded-md w-2/3 hidden" />
                        </div>
                        <div class="md:col-span-3 lg:col-span-4 flex justify-end">
                            <button type="submit" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">+ Adicionar Transação</button>
                        </div>
                    </form>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-700">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">Ativo</th><th class="px-6 py-3">Data</th><th class="px-6 py-3">Quantidade</th><th class="px-6 py-3">Preço Total</th><th class="px-6 py-3">Custos</th><th class="px-6 py-3">Ação</th></tr></thead>
                            <tbody>${tableBody || '<tr><td colspan="7" class="text-center text-gray-500 py-8">Nenhuma transação adicionada.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const renderDividendLedger = () => {
             const tableBody = state.dividends.map(div => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${div.asset}</td>
                    <td class="px-6 py-4">${div.date}</td>
                    <td class="px-6 py-4">${formatCurrency(div.grossAmount, div.currency)}</td>
                    <td class="px-6 py-4">${formatCurrency(div.withholdingTax, div.currency)}</td>
                    <td class="px-6 py-4">${div.source === 'PT_EU_EEE' ? 'PT/EU/EEE' : 'Outra'}</td>
                    <td class="px-6 py-4"><button data-id="${div.id}" class="remove-div-btn text-red-600 hover:text-red-800 font-bold text-lg">&times;</button></td>
                </tr>
            `).join('');

            return `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4 text-brand-blue">Registo de Dividendos e Juros</h3>
                    <form id="div-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 border rounded-lg">
                        <input type="text" name="asset" placeholder="Ativo (e.g., EDPR)" required class="p-2 border rounded-md" />
                        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="p-2 border rounded-md" />
                        <input type="number" name="grossAmount" placeholder="Valor Bruto" required min="0.01" step="any" class="p-2 border rounded-md" />
                        <input type="number" name="withholdingTax" placeholder="Imposto Retido" value="0" min="0" step="any" class="p-2 border rounded-md" />
                        <select name="source" class="p-2 border rounded-md md:col-span-2"><option value="PT_EU_EEE">Fonte PT/EU/EEE</option><option value="OTHER">Outra Fonte</option></select>
                        <div class="flex gap-2">
                            <select name="currency" class="p-2 border rounded-md w-1/3">
                                <option value="EUR">EUR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="CHF">CHF</option>
                            </select>
                            <input type="number" name="exchangeRate" placeholder="Taxa Câmbio p/ EUR" min="0" step="any" class="p-2 border rounded-md w-2/3 hidden" />
                        </div>
                        <div class="md:col-span-2 lg:col-span-4 flex justify-end">
                            <button type="submit" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">+ Adicionar Rendimento</button>
                        </div>
                    </form>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-700">
                             <thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-6 py-3">Ativo</th><th class="px-6 py-3">Data</th><th class="px-6 py-3">Valor Bruto</th><th class="px-6 py-3">Retido na Fonte</th><th class="px-6 py-3">Fonte</th><th class="px-6 py-3">Ação</th></tr></thead>
                            <tbody>${tableBody || '<tr><td colspan="6" class="text-center text-gray-500 py-8">Nenhum dividendo ou juro adicionado.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const renderSimulation = () => {
            if (!state.simulationResult) {
                return `<div class="text-center py-12 text-gray-500"><p class="text-lg">Preencha os dados nas abas anteriores e clique em "Calcular Imposto" para ver a simulação.</p></div>`;
            }
            const { result, annexes } = { result: state.simulationResult, annexes: state.annexData };
            const isFlatRecommended = result.finalChoice === 'FLAT';
            const gainsDetails = result.gainsResult.gainEntries.map(entry => `
                <tr class="border-b">
                    <td class="px-4 py-2">${entry.asset} (${entry.quantity.toFixed(2)})</td>
                    <td class="px-4 py-2">${entry.holdingPeriodDays}</td>
                    <td class="px-4 py-2 ${entry.gain >= 0 ? 'text-green-700' : 'text-red-700'}">${formatCurrency(entry.gain)}</td>
                    <td class="px-4 py-2">${(entry.holdingDiscount * 100).toFixed(0)}%</td>
                    <td class="px-4 py-2 font-medium ${entry.taxableGain >= 0 ? 'text-green-700' : 'text-red-700'}">${formatCurrency(entry.taxableGain)}</td>
                </tr>
            `).join('');

            const annexGData = annexes.g.length > 0 ? annexes.g.map((entry, i) => `Entrada ${i + 1}:\n  Código: G01 - Ações\n  Ano Realização: ${entry.year}\n  Valor Realização: ${entry.valueRealization.toFixed(2)} EUR\n  Ano Aquisição: ${new Date(entry.year).getFullYear()} (FIFO)\n  Valor Aquisição: ${entry.valueAcquisition.toFixed(2)} EUR\n  Despesas: ${entry.expenses.toFixed(2)} EUR\n`).join('\n') : 'Nenhuns dados para o Anexo G.';
            const annexEData = annexes.e.length > 0 ? annexes.e.map((entry, i) => `Entrada ${i + 1}:\n  Código: ${entry.incomeType} - Lucros distribuídos por entidades sujeitas a IRC\n  Rendimentos Brutos: ${entry.grossIncome.toFixed(2)} EUR\n  Retenções na Fonte: (Verificar extratos)\n`).join('\n') : 'Nenhuns dados para o Anexo E.';
            const annexJData = 'Nenhuns dados para o Anexo J. (Esta versão simplificada assume rendimentos domésticos).';
            
            return `
                <div class="space-y-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-6 text-brand-blue border-b pb-2">Simulação de Imposto</h3>
                        ${result.mandatoryAggregation ? `<div class="mb-6 p-4 border-l-4 border-red-500 bg-red-50 text-red-800 rounded-md"><strong>Englobamento Obrigatório:</strong> Foi detetada uma mais-valia de curto prazo e o seu rendimento coletável excede o limiar.</div>` : ''}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="border rounded-lg shadow-md p-6 relative ${isFlatRecommended ? 'bg-green-50 border-green-400' : 'bg-white'}">
                                ${isFlatRecommended ? '<span class="absolute top-0 right-0 bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">Recomendado</span>' : ''}
                                <h4 class="text-lg font-bold text-brand-blue mb-4">Opção 1: Taxa Liberatória (28%)</h4>
                                <div class="space-y-3 text-sm"><p><strong>Imposto Cat. G:</strong> ${formatCurrency(result.flatRate.catGTax)}</p><p><strong>Imposto Cat. E:</strong> ${formatCurrency(result.flatRate.catETax)}</p><p><strong>Crédito Imposto Estrangeiro:</strong> ${formatCurrency(-result.dividendResult.totalWithholding)}</p><hr class="my-2"/><p class="text-lg font-bold">Total a Pagar: <span class="text-brand-red">${formatCurrency(result.flatRate.finalTax)}</span></p></div>
                            </div>
                            <div class="border rounded-lg shadow-md p-6 relative ${!isFlatRecommended ? 'bg-green-50 border-green-400' : 'bg-white'}">
                                ${!isFlatRecommended ? '<span class="absolute top-0 right-0 bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">Recomendado</span>' : ''}
                                <h4 class="text-lg font-bold text-brand-blue mb-4">Opção 2: Englobamento</h4>
                                <div class="space-y-3 text-sm"><p><strong>Rendimento Coletável Total:</strong> ${formatCurrency(result.aggregatedRate.totalTaxableIncome)}</p><p><strong>Coleta (Taxas Progressivas):</strong> ${formatCurrency(result.aggregatedRate.progressiveTax)}</p><p><strong>Taxa Adicional Solidariedade:</strong> ${formatCurrency(result.aggregatedRate.solidaritySurcharge)}</p><p><strong>Crédito Imposto Estrangeiro:</strong> ${formatCurrency(-result.aggregatedRate.foreignTaxCreditUsed)}</p><hr class="my-2"/><p class="text-lg font-bold">Total a Pagar: <span class="text-brand-red">${formatCurrency(result.aggregatedRate.finalTax)}</span></p></div>
                            </div>
                        </div>
                        <div class="mt-8 p-4 bg-gray-100 rounded-lg">
                            <h4 class="font-semibold text-lg mb-2">Detalhe Ganhos de Capital</h4>
                            <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-gray-200"><tr><th class="px-4 py-2">Ativo</th><th class="px-4 py-2">Período (dias)</th><th class="px-4 py-2">Ganho/Perda Bruto</th><th class="px-4 py-2">Desconto</th><th class="px-4 py-2">Ganho/Perda Líquido</th></tr></thead><tbody>${gainsDetails}</tbody></table></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold mb-6 text-brand-blue border-b pb-2">Gerador de Anexos (Simulado)</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-4 rounded-lg shadow"><h4 class="font-bold text-lg mb-2">Anexo G - Mais-Valias</h4><pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"><code class="whitespace-pre-wrap">Quadro 9: Alienação Onerosa de Partes Sociais...\n------------------------------------------------\n${annexGData}</code></pre></div>
                            <div class="space-y-8">
                                <div class="bg-white p-4 rounded-lg shadow"><h4 class="font-bold text-lg mb-2">Anexo E - Rendimentos de Capitais</h4><pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"><code class="whitespace-pre-wrap">Quadro 4B: Rendimentos que foram objeto de retenção...\n------------------------------------------------\n${annexEData}</code></pre></div>
                                <div class="bg-white p-4 rounded-lg shadow"><h4 class="font-bold text-lg mb-2">Anexo J - Rendimentos Obtidos no Estrangeiro</h4><pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"><code class="whitespace-pre-wrap">Quadro 9.2: Ganhos...\nQuadro 8A: Rendimentos...\n------------------------------------------------\n${annexJData}</code></pre></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderApp = () => {
            const container = document.getElementById('app-container');
            let activeContent = '';
            if (state.activeTab === 'CAT_G') activeContent = renderTransactionLedger();
            else if (state.activeTab === 'CAT_E') activeContent = renderDividendLedger();
            else if (state.activeTab === 'SIMULATION') activeContent = renderSimulation();
            
            container.innerHTML = `
                <div class="min-h-screen bg-gray-50 p-4 md:p-8 font-sans">
                    <div class="max-w-7xl mx-auto">
                        <header class="mb-8 p-6 bg-brand-blue text-white rounded-lg shadow-lg">
                            <h1 class="text-3xl md:text-4xl font-bold">Calculadora de IRS</h1>
                            <p class="mt-2 text-lg text-gray-200">Categorias E (Dividendos/Juros) & G (Ganhos de Capital)</p>
                        </header>
                        <main class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <div class="mb-6 p-4 border-l-4 border-yellow-400 bg-yellow-50 text-yellow-800 rounded-md"><strong>Aviso:</strong> Esta ferramenta é um simulador e não substitui aconselhamento fiscal profissional. Para moedas estrangeiras, use a taxa de câmbio do dia da transação.</div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label for="annualIncome" class="block text-sm font-medium text-gray-700 mb-1">Outros Rendimentos Anuais (€)</label>
                                    <input type="number" id="annualIncome" value="${state.annualIncome}" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-blue focus:border-brand-blue" />
                                </div>
                            </div>
                            <div class="border-b border-gray-200 mb-6">
                                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                    <button data-tab="CAT_G" class="tab-btn ${state.activeTab === 'CAT_G' ? 'border-brand-blue text-brand-blue' : 'border-transparent text-gray-500'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Ganhos de Capital (Cat. G)</button>
                                    <button data-tab="CAT_E" class="tab-btn ${state.activeTab === 'CAT_E' ? 'border-brand-blue text-brand-blue' : 'border-transparent text-gray-500'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dividendos/Juros (Cat. E)</button>
                                    <button data-tab="SIMULATION" class="tab-btn ${state.activeTab === 'SIMULATION' ? 'border-brand-blue text-brand-blue' : 'border-transparent text-gray-500'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Simulação & Anexos</button>
                                </nav>
                            </div>
                            <div id="tab-content">${activeContent}</div>
                            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end">
                                <button id="calculate-btn" class="bg-brand-green hover:bg-opacity-90 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">Calcular Imposto</button>
                            </div>
                        </main>
                        <footer class="text-center mt-8 text-gray-500 text-sm"><p>&copy; ${new Date().getFullYear()} Calculadora IRS Portugal. Todos os direitos reservados.</p></footer>
                    </div>
                </div>
            `;
            addEventListeners();
        };

        // --- EVENT HANDLING ---
        function addEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
                state.activeTab = e.target.dataset.tab;
                renderApp();
            }));

            document.getElementById('calculate-btn').addEventListener('click', () => {
                const transactionsInEUR = state.transactions.map(t => {
                    if (t.currency === 'EUR' || !t.exchangeRate || t.exchangeRate === 1) return t;
                    return { ...t, price: t.price * t.exchangeRate, costs: t.costs * t.exchangeRate };
                });
                const dividendsInEUR = state.dividends.map(d => {
                    if (d.currency === 'EUR' || !d.exchangeRate || d.exchangeRate === 1) return d;
                    return { ...d, grossAmount: d.grossAmount * d.exchangeRate, withholdingTax: d.withholdingTax * d.exchangeRate };
                });

                const { result, annexes } = calculateTaxSimulation(transactionsInEUR, dividendsInEUR, state.annualIncome);
                state.simulationResult = result;
                state.annexData = annexes;
                state.activeTab = 'SIMULATION';
                renderApp();
            });
            
            document.getElementById('annualIncome').addEventListener('change', (e) => {
                state.annualIncome = parseFloat(e.target.value) || 0;
            });

            const setupCurrencyHandler = (formId) => {
                const form = document.getElementById(formId);
                if (!form) return;
                const currencySelect = form.querySelector('select[name="currency"]');
                const exchangeRateInput = form.querySelector('input[name="exchangeRate"]');
                currencySelect.addEventListener('change', (e) => {
                    if (e.target.value === 'EUR') {
                        exchangeRateInput.classList.add('hidden');
                        exchangeRateInput.value = '';
                        exchangeRateInput.required = false;
                    } else {
                        exchangeRateInput.classList.remove('hidden');
                        exchangeRateInput.required = true;
                    }
                });
            };

            if (state.activeTab === 'CAT_G') {
                const txForm = document.getElementById('tx-form');
                if (txForm) {
                    txForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const newTx = {
                            id: Date.now().toString(),
                            type: formData.get('type'),
                            asset: formData.get('asset'),
                            date: formData.get('date'),
                            quantity: parseFloat(formData.get('quantity')),
                            price: parseFloat(formData.get('price')),
                            costs: parseFloat(formData.get('costs')),
                            currency: formData.get('currency'),
                            exchangeRate: parseFloat(formData.get('exchangeRate')) || 1,
                        };
                        state.transactions.push(newTx);
                        renderApp();
                    });
                }
                document.querySelectorAll('.remove-tx-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    state.transactions = state.transactions.filter(tx => tx.id !== e.target.dataset.id);
                    renderApp();
                }));
                setupCurrencyHandler('tx-form');
            }

            if (state.activeTab === 'CAT_E') {
                const divForm = document.getElementById('div-form');
                 if (divForm) {
                    divForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const newDiv = {
                            id: Date.now().toString(),
                            asset: formData.get('asset'),
                            date: formData.get('date'),
                            grossAmount: parseFloat(formData.get('grossAmount')),
                            withholdingTax: parseFloat(formData.get('withholdingTax')),
                            source: formData.get('source'),
                            currency: formData.get('currency'),
                            exchangeRate: parseFloat(formData.get('exchangeRate')) || 1,
                        };
                        state.dividends.push(newDiv);
                        renderApp();
                    });
                }
                 document.querySelectorAll('.remove-div-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    state.dividends = state.dividends.filter(div => div.id !== e.target.dataset.id);
                    renderApp();
                }));
                setupCurrencyHandler('div-form');
            }
        }

        // --- INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', renderApp);
    </script>
  </body>
</html>
